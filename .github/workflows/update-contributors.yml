name: ðŸ§‘â€ðŸ’» Smart Contributor Updater

on:
  schedule:
    - cron: "0 * * * *" # Setiap 1 jam
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    name: ðŸ§¾ Auto Update Contributors in README.md

    steps:
      - name: ðŸ§© Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ”¹ Ambil daftar contributor terbaru dari GitHub API
      - name: ðŸ“¥ Get Current Contributor Hash
        id: contributors
        run: |
          curl -s "https://api.github.com/repos/${{ github.repository }}/contributors?per_page=100" \
          | jq -r '.[].login' | sort | md5sum | cut -d " " -f1 > new_hash.txt
          echo "hash=$(cat new_hash.txt)" >> $GITHUB_OUTPUT

      # ðŸ”¹ Baca hash contributor lama dari cache repo
      - name: ðŸ’¾ Get Previous Hash
        id: previous
        run: |
          if [ -f .contributors_hash ]; then
            echo "hash=$(cat .contributors_hash)" >> $GITHUB_OUTPUT
          else
            echo "hash=none" >> $GITHUB_OUTPUT
          fi

      # ðŸ”¹ Bandingkan hash contributor lama dan baru
      - name: ðŸ” Compare Contributor Hashes
        id: compare
        run: |
          if [ "${{ steps.contributors.outputs.hash }}" = "${{ steps.previous.outputs.hash }}" ]; then
            echo "same=true" >> $GITHUB_OUTPUT
            echo "âœ… No new contributors found."
          else
            echo "same=false" >> $GITHUB_OUTPUT
            echo "ðŸ†• New contributors detected!"
          fi

      # ðŸ”¹ Update contributor list di README.md (bagian <!-- readme: contributors -start -->)
      - name: âœï¸ Update Contributors in README.md
        if: steps.compare.outputs.same == 'false'
        uses: akhilmhdh/contributors-readme-action@v2.3.11
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          readme_path: "README.md"
          image_size: 100
          columns_per_row: 6
          use_username: true
          commit_message: "ðŸ§‘â€ðŸ’» chore: update contributors list"

      # ðŸ”¹ Simpan hash contributor terbaru (biar tidak update berulang kali)
      - name: ðŸ’¾ Save New Contributor Hash
        if: steps.compare.outputs.same == 'false'
        run: |
          echo "${{ steps.contributors.outputs.hash }}" > .contributors_hash
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .contributors_hash
          git commit -m "ðŸ”„ Update contributor hash" || echo "no changes"
          git push

      # ðŸ”¹ (Opsional) Buat PR otomatis kalau branch utama dilindungi
      - name: ðŸš€ Create Pull Request (if branch protected)
        if: steps.compare.outputs.same == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "auto/update-contributors"
          title: "ðŸ¤– Auto update contributors list"
          body: "Automatically updated the contributor section in README.md ðŸ’«"
